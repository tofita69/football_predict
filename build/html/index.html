<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Football Time Series Predictor Documentation &mdash; Football Time Series Predictor  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            Football Time Series Predictor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Football Time Series Predictor Documentation</a><ul>
<li><a class="reference internal" href="#contents"><strong>Contents:</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#introduction"><strong>Introduction</strong></a><ul>
<li><a class="reference internal" href="#motivation"><strong>Motivation</strong></a></li>
<li><a class="reference internal" href="#key-features"><strong>Key Features</strong></a></li>
<li><a class="reference internal" href="#project-structure"><strong>Project Structure</strong></a></li>
<li><a class="reference internal" href="#target-audience"><strong>Target Audience</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-acquisition"><strong>Data Acquisition</strong></a><ul>
<li><a class="reference internal" href="#data-source"><strong>Data Source</strong></a></li>
<li><a class="reference internal" href="#logo-placeholder"><strong>Logo Placeholder</strong></a></li>
<li><a class="reference internal" href="#steps-to-acquire-data"><strong>Steps to Acquire Data</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-manipulation"><strong>Data Manipulation</strong></a></li>
<li><a class="reference internal" href="#preprocessing">Preprocessing</a><ul>
<li><a class="reference internal" href="#step-1-load-datasets">Step 1: Load Datasets</a></li>
<li><a class="reference internal" href="#step-2-extract-season-information">Step 2: Extract Season Information</a></li>
<li><a class="reference internal" href="#step-3-standardize-team-names">Step 3: Standardize Team Names</a></li>
<li><a class="reference internal" href="#step-4-merge-datasets">Step 4: Merge Datasets</a></li>
<li><a class="reference internal" href="#step-5-clean-up-columns">Step 5: Clean Up Columns</a></li>
<li><a class="reference internal" href="#step-6-save-the-combined-data">Step 6: Save the Combined Data</a></li>
<li><a class="reference internal" href="#step-7-additional-cleaning-and-feature-engineering">Step 7: Additional Cleaning and Feature Engineering</a></li>
<li><a class="reference internal" href="#step-8-add-features-and-normalize-data">Step 8: Add Features and Normalize Data</a></li>
<li><a class="reference internal" href="#step-9-one-hot-encoding">Step 9: One hot encoding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exploratory-data-analysis-eda">Exploratory Data Analysis (EDA)</a><ul>
<li><a class="reference internal" href="#step-1-descriptive-statistics">Step 1: Descriptive Statistics</a></li>
<li><a class="reference internal" href="#step-2-distribution-of-xg-difference">Step 2: Distribution of xG_Difference</a></li>
<li><a class="reference internal" href="#step-3-correlation-matrix">Step 3: Correlation Matrix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modeling"><strong>Modeling</strong></a><ul>
<li><a class="reference internal" href="#step-1-prepare-data-for-modeling">Step 1: Prepare Data for Modeling</a></li>
<li><a class="reference internal" href="#step-2-time-based-data-split">Step 2: Time-Based Data Split</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sarimax">SARIMAX</a><ul>
<li><a class="reference internal" href="#introduction-to-sarimax">Introduction to SARIMAX</a></li>
<li><a class="reference internal" href="#model-building">Model Building</a></li>
<li><a class="reference internal" href="#hyperparameter-tuning">Hyperparameter Tuning</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lstm-for-time-series-forecasting">LSTM for Time Series Forecasting</a><ul>
<li><a class="reference internal" href="#id1"><strong>Introduction</strong></a></li>
<li><a class="reference internal" href="#data-preparation"><strong>Data Preparation</strong></a></li>
<li><a class="reference internal" href="#id2"><strong>Model Building</strong></a></li>
<li><a class="reference internal" href="#model-visualization"><strong>Model Visualization</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#enhanced-transformer-model">Enhanced Transformer Model</a><ul>
<li><a class="reference internal" href="#id3"><strong>Introduction</strong></a></li>
<li><a class="reference internal" href="#model-architecture"><strong>Model Architecture</strong></a></li>
<li><a class="reference internal" href="#model-implementation"><strong>Model Implementation</strong></a></li>
<li><a class="reference internal" href="#model-training-and-evaluation"><strong>Model Training and Evaluation</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#general-conclusion"><strong>General Conclusion</strong></a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">Football Time Series Predictor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Football Time Series Predictor Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="football-time-series-predictor-documentation">
<h1>Football Time Series Predictor Documentation<a class="headerlink" href="#football-time-series-predictor-documentation" title="Link to this heading"></a></h1>
<p>Welcome to the documentation for the Football Time Series Predictor! This project explores
the effectiveness of two powerful time series modeling approaches—Long Short-Term Memory (LSTM) networks
and Transformer models—for predicting goal differences in football matches. The project compares the performance
of these models on historical match data.</p>
<section id="contents">
<h2><strong>Contents:</strong><a class="headerlink" href="#contents" title="Link to this heading"></a></h2>
<div class="toctree-wrapper compound">
</div>
<p><strong>Extensions:</strong></p>
<ul class="simple">
<li><p>autosectionlabel</p></li>
</ul>
<p><strong>Master file:</strong></p>
<ul class="simple">
<li><p>index.rst</p></li>
</ul>
<p><strong>Sections:</strong></p>
<ul class="simple">
<li><p>Introduction</p></li>
<li><p>Data Acquisition</p></li>
<li><p>Data Manipulation</p></li>
<li><p>Preprocessing</p></li>
<li><p>EDA</p></li>
<li><p>Modeling</p></li>
<li><p>SARIMAX</p></li>
<li><p>LSTM</p></li>
<li><p>Transformers</p></li>
<li><p>Conclusion</p></li>
</ul>
</section>
</section>
<section id="introduction">
<h1><strong>Introduction</strong><a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>Welcome to the documentation for the Football Time Series Predictor! This project employs advanced time series forecasting techniques, specifically Long Short-Term Memory (LSTM) neural networks and Transformer models, to predict goal differences in football (soccer) matches. By analyzing historical match data and relevant features, the predictor aims to provide insights into potential match outcomes.</p>
<section id="motivation">
<h2><strong>Motivation</strong><a class="headerlink" href="#motivation" title="Link to this heading"></a></h2>
<p>Predicting football match outcomes is a complex task due to the numerous factors that can influence a game. Traditional statistical methods often struggle to capture the dynamic and sequential nature of football data. This project addresses this challenge by utilizing time series models capable of learning from temporal patterns and dependencies in historical match data. The goal is not to definitively predict the future, but rather to provide probabilistic insights into potential goal differences, which can be valuable for analysis and understanding team performance.</p>
</section>
<section id="key-features">
<h2><strong>Key Features</strong><a class="headerlink" href="#key-features" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Time Series Approach:</strong> The project focuses on time series analysis, recognizing the importance of the order and sequence of match data.</p></li>
<li><p><strong>LSTM Networks:</strong> Long Short-Term Memory (LSTM) networks, a type of recurrent neural network, are used to capture long-term dependencies in the data.</p></li>
<li><p><strong>Transformer Models:</strong> Transformer models, known for their powerful sequence modeling capabilities, are also employed and compared with LSTMs.</p></li>
<li><p><strong>Feature Engineering:</strong> Relevant features, such as expected goals (xG), shots per 90 minutes, and team-specific features, are engineered to improve model accuracy.</p></li>
<li><p><strong>Evaluation Metrics:</strong> The performance of the models is evaluated using appropriate metrics, such as Root Mean Squared Error (RMSE).</p></li>
</ul>
</section>
<section id="project-structure">
<h2><strong>Project Structure</strong><a class="headerlink" href="#project-structure" title="Link to this heading"></a></h2>
<p>The project is organized as follows:</p>
<ul class="simple">
<li><p><strong>Data Collection and Preprocessing:</strong> Data is collected from the <code class="docutils literal notranslate"><span class="pre">worldfootballR</span></code> R package, merged, preprocessed, and prepared for the models.</p></li>
<li><p><strong>Model Training and Evaluation:</strong> LSTM and Transformer models are trained on historical data and evaluated on a held-out test set.</p></li>
<li><p><strong>Prediction:</strong> The trained models can be used to predict goal differences for new, unseen matches.</p></li>
</ul>
</section>
<section id="target-audience">
<h2><strong>Target Audience</strong><a class="headerlink" href="#target-audience" title="Link to this heading"></a></h2>
<p>This documentation is intended for:</p>
<ul class="simple">
<li><p>Data scientists and machine learning practitioners interested in time series forecasting in sports.</p></li>
<li><p>Football analysts and enthusiasts looking for quantitative methods to analyze match outcomes.</p></li>
<li><p>Developers who want to use or contribute to the project.</p></li>
</ul>
</section>
</section>
<section id="data-acquisition">
<h1><strong>Data Acquisition</strong><a class="headerlink" href="#data-acquisition" title="Link to this heading"></a></h1>
<section id="data-source">
<h2><strong>Data Source</strong><a class="headerlink" href="#data-source" title="Link to this heading"></a></h2>
<p>The historical match data used in this project was collected using the <code class="docutils literal notranslate"><span class="pre">worldfootballR</span></code> R package. This package provides access to a rich repository of football data, including match results, team statistics, player performance, and more.</p>
</section>
<section id="logo-placeholder">
<h2><strong>Logo Placeholder</strong><a class="headerlink" href="#logo-placeholder" title="Link to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/logo.png"><img alt="worldfootballR Logo" src="_images/logo.png" style="width: 200px;" /></a>
</section>
<section id="steps-to-acquire-data">
<h2><strong>Steps to Acquire Data</strong><a class="headerlink" href="#steps-to-acquire-data" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p><strong>Install Required Tools:</strong> Ensure that R and RStudio are installed on your system along with the <code class="docutils literal notranslate"><span class="pre">worldfootballR</span></code> package. You can install the package by running the following command in your R console:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;worldfootballR&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;devtools&quot;</span><span class="p">)</span>
<span class="n">devtools</span><span class="o">::</span><span class="nf">install_github</span><span class="p">(</span><span class="s">&quot;JaseZiv/worldfootballR&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;dplyr&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># dplyr will aid in quick viewing of data and filtering table data</span>
</pre></div>
</div>
</li>
<li><p><strong>Fetch matchs data:</strong> Use the package function fb_match_results to get the match results from 2018:2024. Here’s the specific code used:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">worldfootballR</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="c1"># Define the seasons you want</span>
<span class="n">seasons</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2018</span><span class="o">:</span><span class="m">2024</span>

<span class="n">all_matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">()</span><span class="w"> </span><span class="c1"># Initialize an empty data frame</span>

<span class="nf">for </span><span class="p">(</span><span class="n">season</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">seasons</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nf">tryCatch</span><span class="p">({</span><span class="w"> </span><span class="c1"># Use tryCatch to handle potential errors</span>
<span class="w">      </span><span class="n">season_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fb_match_results</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ENG&quot;</span><span class="p">,</span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;M&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">season_end_year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">season</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1st&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">all_matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">bind_rows</span><span class="p">(</span><span class="n">all_matches</span><span class="p">,</span><span class="w"> </span><span class="n">season_data</span><span class="p">)</span><span class="w"> </span><span class="c1"># Append to the main data frame</span>
<span class="w">      </span><span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Data for&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">season</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;season collected.&quot;</span><span class="p">))</span>
<span class="w">   </span><span class="p">},</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Error collecting data for&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">season</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="o">$</span><span class="n">message</span><span class="p">))</span>
<span class="w">   </span><span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Clean and transform the data</span>
<span class="n">all_matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">all_matches</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="nf">mutate</span><span class="p">(</span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="c1"># Ensure Date is in Date format</span>

<span class="c1"># View the first few rows</span>
<span class="nf">head</span><span class="p">(</span><span class="n">all_matches</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Fetch Shooting Statistics:</strong> Use the package functions to extract historical shooting statistics for teams from 2018 to 2024. Here’s the specific code used:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">worldfootballR</span><span class="p">)</span>

<span class="c1"># Fetch shooting statistics for teams from 2018 to 2024</span>
<span class="n">shooting_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">get_team_stats</span><span class="p">(</span>
<span class="w">    </span><span class="n">team_or_player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;team&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">stat_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shooting&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">season_end_year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2018</span><span class="o">:</span><span class="m">2024</span>
<span class="p">)</span>

<span class="c1"># View the first few rows of the data</span>
<span class="nf">head</span><span class="p">(</span><span class="n">shooting_data</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Export Data:</strong> Once the data is fetched, save it to a CSV file for preprocessing in Python:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">write.csv</span><span class="p">(</span><span class="n">shooting_data</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shooting_data.csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">write.csv</span><span class="p">(</span><span class="n">all_matches</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all_matches.csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="data-manipulation">
<h1><strong>Data Manipulation</strong><a class="headerlink" href="#data-manipulation" title="Link to this heading"></a></h1>
<p>After exporting the data from R, the preprocessing steps were conducted in Python. These steps included:</p>
<ol class="arabic simple">
<li><p><strong>Merging Tables:</strong> The <cite>match_data.csv</cite> and <cite>shooting_data.csv</cite> tables were merged using a Python notebook to combine relevant features for analysis.</p></li>
<li><p><strong>Cleaning Data:</strong> Handling missing values, correcting inconsistencies, and ensuring data types were appropriate for analysis.</p></li>
<li><p><strong>Feature Engineering:</strong> Creating additional features to improve model performance, such as rolling averages for key statistics and lag variables to account for temporal dependencies.</p></li>
</ol>
<p>The preprocessing workflow was essential for preparing the data to be used effectively by the LSTM and Transformer models.</p>
</section>
<section id="preprocessing">
<h1>Preprocessing<a class="headerlink" href="#preprocessing" title="Link to this heading"></a></h1>
<p>This section describes the preprocessing steps applied to prepare the football dataset for analysis.</p>
<section id="step-1-load-datasets">
<h2>Step 1: Load Datasets<a class="headerlink" href="#step-1-load-datasets" title="Link to this heading"></a></h2>
<p>The datasets containing match data and team statistics are loaded using pandas.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Load datasets</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/premier_league_matches.csv&quot;</span><span class="p">)</span>
<span class="n">team_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/team_stats.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-2-extract-season-information">
<h2>Step 2: Extract Season Information<a class="headerlink" href="#step-2-extract-season-information" title="Link to this heading"></a></h2>
<p>Extract the <cite>Season</cite> column from the <cite>Season_End_Year</cite> field in the matches dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract Season from Matches Data</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Season_End_Year&#39;</span><span class="p">])</span>  <span class="c1"># Convert to numeric</span>
</pre></div>
</div>
</section>
<section id="step-3-standardize-team-names">
<h2>Step 3: Standardize Team Names<a class="headerlink" href="#step-3-standardize-team-names" title="Link to this heading"></a></h2>
<p>Ensure consistency in team names across datasets by mapping alternative names to a common format.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standardize Team Names</span>
<span class="n">team_name_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Manchester United&quot;</span><span class="p">:</span> <span class="s2">&quot;Manchester Utd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tottenham Hotspur&quot;</span><span class="p">:</span> <span class="s2">&quot;Tottenham&quot;</span><span class="p">,</span>
    <span class="c1"># Add other mappings as needed</span>
<span class="p">}</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Home&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Home&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">team_name_mapping</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Home&#39;</span><span class="p">])</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Away&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Away&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">team_name_mapping</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Away&#39;</span><span class="p">])</span>
<span class="n">team_stats</span><span class="p">[</span><span class="s1">&#39;Squad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">team_stats</span><span class="p">[</span><span class="s1">&#39;Squad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">team_name_mapping</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">team_stats</span><span class="p">[</span><span class="s1">&#39;Squad&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="step-4-merge-datasets">
<h2>Step 4: Merge Datasets<a class="headerlink" href="#step-4-merge-datasets" title="Link to this heading"></a></h2>
<p>Combine match data with team statistics for home and away teams.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Merge for Home Teams</span>
<span class="n">merged_data</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">team_stats</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Season&#39;</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">],</span>
    <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Season_End_Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Squad&#39;</span><span class="p">],</span>
    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_Home&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Merge for Away Teams</span>
<span class="n">merged_data</span> <span class="o">=</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">team_stats</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Season&#39;</span><span class="p">,</span> <span class="s1">&#39;Away&#39;</span><span class="p">],</span>
    <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Season_End_Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Squad&#39;</span><span class="p">],</span>
    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_Away&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-5-clean-up-columns">
<h2>Step 5: Clean Up Columns<a class="headerlink" href="#step-5-clean-up-columns" title="Link to this heading"></a></h2>
<p>Remove duplicate columns created during merging.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove Duplicate Columns</span>
<span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Season_End_Year_Home&#39;</span><span class="p">,</span> <span class="s1">&#39;Squad_Home&#39;</span><span class="p">,</span> <span class="s1">&#39;Season_End_Year_Away&#39;</span><span class="p">,</span> <span class="s1">&#39;Squad_Away&#39;</span><span class="p">]</span>
<span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_to_drop</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">merged_data</span> <span class="o">=</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_drop</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-6-save-the-combined-data">
<h2>Step 6: Save the Combined Data<a class="headerlink" href="#step-6-save-the-combined-data" title="Link to this heading"></a></h2>
<p>Save the merged dataset to a CSV file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save the Combined Data</span>
<span class="n">merged_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/combined_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Combined data saved to combined_data.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-7-additional-cleaning-and-feature-engineering">
<h2>Step 7: Additional Cleaning and Feature Engineering<a class="headerlink" href="#step-7-additional-cleaning-and-feature-engineering" title="Link to this heading"></a></h2>
<p>Further process the combined data to calculate cumulative statistics, rankings, and other features.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load combined data</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/combined_data.csv&quot;</span><span class="p">)</span>

<span class="c1"># Convert date and sort matches</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Season_End_Year&#39;</span><span class="p">])</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Season&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define function to calculate cumulative stats and rankings</span>
<span class="k">def</span> <span class="nf">calculate_cumulative_stats_and_rankings</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># Initialize cumulative stats</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HomePoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AwayPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HomeGF_cum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HomeGA_cum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AwayGF_cum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AwayGA_cum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HomeRank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AwayRank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cumulative_stats</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
        <span class="c1"># ... (code for calculating stats and rankings)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Apply function to calculate stats</span>
<span class="n">merged_data</span> <span class="o">=</span> <span class="n">calculate_cumulative_stats_and_rankings</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-8-add-features-and-normalize-data">
<h2>Step 8: Add Features and Normalize Data<a class="headerlink" href="#step-8-add-features-and-normalize-data" title="Link to this heading"></a></h2>
<p>Create new features such as goal difference, normalize numeric features, and save the cleaned data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Add calculated features</span>
<span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">]</span>
<span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;xG_Difference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Home_xG&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Away_xG&#39;</span><span class="p">]</span>

<span class="c1"># Select and clean final features</span>
<span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">,</span> <span class="s1">&#39;Away&#39;</span><span class="p">,</span> <span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;xG_Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;Season&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Sh_per_90_Standard&#39;</span><span class="p">,</span> <span class="s1">&#39;SoT_percent_Standard&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Sh_per_90_Standard_Away&#39;</span><span class="p">,</span> <span class="s1">&#39;SoT_percent_Standard_Away&#39;</span><span class="p">,</span> <span class="s1">&#39;HomeRank&#39;</span><span class="p">,</span> <span class="s1">&#39;AwayRank&#39;</span>
<span class="p">]</span>
<span class="n">merged_data</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span>

<span class="c1"># Standardize numeric features</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;xG_Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;Sh_per_90_Standard&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;SoT_percent_Standard&#39;</span><span class="p">,</span> <span class="s1">&#39;Sh_per_90_Standard_Away&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;SoT_percent_Standard_Away&#39;</span><span class="p">,</span> <span class="s1">&#39;HomeRank&#39;</span><span class="p">,</span> <span class="s1">&#39;AwayRank&#39;</span><span class="p">]</span>
<span class="n">merged_data</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>

<span class="c1"># Save the cleaned data</span>
<span class="n">merged_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/cleaned_combined_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cleaned combined data saved to cleaned_combined_data.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-9-one-hot-encoding">
<h2>Step 9: One hot encoding<a class="headerlink" href="#step-9-one-hot-encoding" title="Link to this heading"></a></h2>
<p>Encode categorical features such as the team names (Home and Away) using one-hot encoding.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform One Hot Encoding</span>
<span class="n">one_hot_encoded_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">merged_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Home&#39;</span><span class="p">,</span> <span class="s1">&#39;Away&#39;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Home_Team&#39;</span><span class="p">,</span> <span class="s1">&#39;Away_Team&#39;</span><span class="p">])</span>

<span class="c1"># Save the one-hot encoded data</span>
<span class="n">one_hot_encoded_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/one_hot_encoded_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One-hot encoded data saved to one_hot_encoded_data.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>One-hot encoding ensures categorical data, like team names, is transformed into a numerical format without introducing unintended ordinal relationships. This is essential for accurate model training, as machine learning algorithms require numerical inputs to process data correctly.</p>
</section>
</section>
<section id="exploratory-data-analysis-eda">
<h1>Exploratory Data Analysis (EDA)<a class="headerlink" href="#exploratory-data-analysis-eda" title="Link to this heading"></a></h1>
<p>This section focuses on exploring the dataset through descriptive statistics and visualizations.</p>
<section id="step-1-descriptive-statistics">
<h2>Step 1: Descriptive Statistics<a class="headerlink" href="#step-1-descriptive-statistics" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Descriptive statistics for numerical features</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Descriptive Statistics:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">matches</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/descriptiveStatistic.png"><img alt="_images/descriptiveStatistic.png" src="_images/descriptiveStatistic.png" style="width: 600px;" /></a>
</section>
<section id="step-2-distribution-of-xg-difference">
<h2>Step 2: Distribution of xG_Difference<a class="headerlink" href="#step-2-distribution-of-xg-difference" title="Link to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/xGDiff.png"><img alt="_images/xGDiff.png" src="_images/xGDiff.png" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This plot will display the distribution of the ‘xG_Difference’ column, indicating how expected goal differences are spread across the dataset.</p>
</div>
</section>
<section id="step-3-correlation-matrix">
<h2>Step 3: Correlation Matrix<a class="headerlink" href="#step-3-correlation-matrix" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate and visualize the correlation matrix</span>
<span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;xG_Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;Sh_per_90_Standard&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;SoT_percent_Standard&#39;</span><span class="p">,</span> <span class="s1">&#39;Sh_per_90_Standard_Away&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;SoT_percent_Standard_Away&#39;</span><span class="p">,</span> <span class="s1">&#39;HomeRank&#39;</span><span class="p">,</span> <span class="s1">&#39;AwayRank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlation Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/corrmatrix.png"><img alt="_images/corrmatrix.png" src="_images/corrmatrix.png" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The correlation matrix heatmap identifies relationships between numerical features, highlighting dependencies or lack thereof.
It visualizes relationships between key variables. Strong correlations are evident, such as between GoalDifference and xG_Difference (0.66),
while negative correlations exist, like Sh_per_90_Standard and HomeRank (-0.59). This highlights dependencies useful for prediction.</p>
</div>
</section>
</section>
<section id="modeling">
<h1><strong>Modeling</strong><a class="headerlink" href="#modeling" title="Link to this heading"></a></h1>
<section id="step-1-prepare-data-for-modeling">
<h2>Step 1: Prepare Data for Modeling<a class="headerlink" href="#step-1-prepare-data-for-modeling" title="Link to this heading"></a></h2>
<p>In this step, we prepare the data by selecting relevant features, encoding categorical variables, and splitting the data for time-based cross-validation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare data</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Season&#39;</span><span class="p">])</span>  <span class="c1"># Drop Date and Season from features</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">]</span>  <span class="c1"># Target variable</span>

<span class="c1"># Convert one-hot encoded columns to float</span>
<span class="n">one_hot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Home_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Away_&#39;</span><span class="p">)]</span>
<span class="n">X</span><span class="p">[</span><span class="n">one_hot_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">one_hot_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
<p>Explanation:
- <strong>Features (`X`)</strong>: We drop <cite>GoalDifference</cite> (target), <cite>Date</cite>, and <cite>Season</cite> as they are not predictive features.
- <strong>Target (`y`)</strong>: Extract the <cite>GoalDifference</cite> column as the target variable.
- <strong>One-hot encoding</strong>: Ensure all categorical columns are of the correct type (float).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This step ensures that the data is ready for the modeling pipeline and avoids issues with data types.</p>
</div>
</section>
<section id="step-2-time-based-data-split">
<h2>Step 2: Time-Based Data Split<a class="headerlink" href="#step-2-time-based-data-split" title="Link to this heading"></a></h2>
<p>Using a time-series split for cross-validation ensures that the model is evaluated on unseen, chronologically ordered data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time-based split using TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>

<span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Define 5 splits for cross-validation</span>

<span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

<span class="c1"># Splitting data into training and testing sets</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Season&#39;</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Season&#39;</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Explanation:
- <strong>TimeSeriesSplit</strong>: Ensures that the model is trained on past data and tested on future data, avoiding data leakage.
- <strong>Training and Testing Sets</strong>: Splits data into chronological subsets for training (<cite>X_train</cite>, <cite>y_train</cite>) and testing (<cite>X_test</cite>, <cite>y_test</cite>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This approach respects the temporal structure of the data, making it ideal for time-series forecasting tasks.</p>
</div>
</section>
</section>
<section id="sarimax">
<span id="sarimax-modeling"></span><h1>SARIMAX<a class="headerlink" href="#sarimax" title="Link to this heading"></a></h1>
<section id="introduction-to-sarimax">
<h2>Introduction to SARIMAX<a class="headerlink" href="#introduction-to-sarimax" title="Link to this heading"></a></h2>
<p>The Seasonal Autoregressive Integrated Moving Average with eXogenous regressors (SARIMAX) model is a powerful tool for time series forecasting, especially when dealing with data that exhibits seasonality. It builds upon the ARIMA model by incorporating seasonal components and allowing for the inclusion of external factors (exogenous variables) that might influence the target variable.</p>
</section>
<section id="model-building">
<h2>Model Building<a class="headerlink" href="#model-building" title="Link to this heading"></a></h2>
<p>Importing Libraries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
<p>Data Preparation:</p>
<ul class="simple">
<li><p>Select the target variable (y) you want to predict and the exogenous variables (X) that might influence it.</p></li>
<li><p>Handle missing values in a suitable way, such as imputation or deletion.</p></li>
<li><p>Consider transformations or scaling of the data if necessary for model stability.</p></li>
</ul>
<p>Model Training:</p>
<ol class="arabic simple">
<li><p><strong>Specifying the Model:</strong></p>
<ul class="simple">
<li><p>We use the <code class="docutils literal notranslate"><span class="pre">statsmodels.api.SARIMAX</span></code> function to define the model.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">order</span></code> argument defines the non-seasonal ARIMA components:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code>: The number of autoregressive (AR) terms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">d</span></code>: The degree of differencing needed to achieve stationarity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">q</span></code>: The number of moving average (MA) terms.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">seasonal_order</span></code> argument defines the seasonal components:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">P</span></code>: The number of seasonal AR terms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">D</span></code>: The degree of seasonal differencing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Q</span></code>: The number of seasonal MA terms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s</span></code>: The seasonal period (e.g., number of days in a week, months in a year).</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Fitting the Model:</strong></p>
<ul class="simple">
<li><p>We use the <code class="docutils literal notranslate"><span class="pre">fit</span></code> method on the defined model to train it on the training data (<code class="docutils literal notranslate"><span class="pre">y_train</span></code> and optionally <code class="docutils literal notranslate"><span class="pre">X_train</span></code> for exogenous variables).</p></li>
</ul>
</li>
</ol>
<p>Our Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">SARIMAX</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">model_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
<p>In this example, we fit a SARIMAX model with:</p>
<ul class="simple">
<li><p>Non-seasonal ARIMA order: (1, 0, 1) - one AR term, no differencing, and one MA term.</p></li>
<li><p>Seasonal order: (1, 0, 0, 10) - one seasonal AR term, no seasonal differencing, no seasonal MA terms, and a seasonal period of 10 (likely indicating a daily or weekly seasonality).</p></li>
</ul>
<p>Evaluation Metrics:</p>
<ul class="simple">
<li><p>After fitting the model, we use the <code class="docutils literal notranslate"><span class="pre">forecast</span></code> method to predict future values (<code class="docutils literal notranslate"><span class="pre">y_pred</span></code>) on the test data (<code class="docutils literal notranslate"><span class="pre">X_test</span></code>).</p></li>
<li><p>We then evaluate the model’s performance using metrics like Root Mean Squared Error (RMSE) calculated with <code class="docutils literal notranslate"><span class="pre">sklearn.metrics.mean_squared_error</span></code>.</p></li>
</ul>
<p>Our Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">exog</span><span class="o">=</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Visualization:</p>
<ul class="simple">
<li><p>Visualizing the actual vs. predicted values using <code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> can be helpful to assess the model’s performance graphically.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/Arimax.png"><img alt="_images/Arimax.png" src="_images/Arimax.png" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In our case, the SARIMAX model yielded the following results:</p>
<ul class="simple">
<li><p>RMSE: 0.822</p></li>
<li><p>MAE: 0.636</p></li>
</ul>
<p><strong>Observation:</strong> The RMSE (0.822) is higher than the MAE (0.636).
This is a common occurrence. RMSE gives more weight to larger errors due to the squaring operation.
The fact that the RMSE is noticeably larger than the MAE suggests that there are some larger prediction errors in the model.</p>
<blockquote>
<div><p>Further investigation into these larger errors might be beneficial, perhaps through residual analysis or by exploring additional features or model adjustments. While the model provides</p>
</div></blockquote>
<p>reasonable predictions (as indicated by the MAE), minimizing the larger errors could further improve its overall accuracy.</p>
</div>
</section>
<section id="hyperparameter-tuning">
<h2>Hyperparameter Tuning<a class="headerlink" href="#hyperparameter-tuning" title="Link to this heading"></a></h2>
<p>Finding the optimal model parameters (p, d, q, P, D, Q, s) is crucial for good forecasting performance. You’ve included an example using a grid search approach with <code class="docutils literal notranslate"><span class="pre">itertools</span></code>:</p>
<ul class="simple">
<li><p>This code defines ranges for each parameter and iterates through all possible combinations within those ranges.</p></li>
<li><p>For each combination, it trains a SARIMAX model and evaluates its performance using AIC (Akaike Information Criterion).</p></li>
<li><p>The model with the lowest AIC is considered the best performing one.</p></li>
</ul>
<p>Additional Considerations:</p>
<ul class="simple">
<li><p>Consider using techniques like early stopping to avoid fitting models that are not converging.</p></li>
<li><p>Explore more sophisticated hyperparameter tuning methods like randomized search or Bayesian optimization.</p></li>
</ul>
<p>By implementing SARIMAX modeling and hyperparameter tuning, you can build robust and accurate time series forecasts.</p>
</section>
</section>
<section id="lstm-for-time-series-forecasting">
<span id="lstm-modeling"></span><h1>LSTM for Time Series Forecasting<a class="headerlink" href="#lstm-for-time-series-forecasting" title="Link to this heading"></a></h1>
<section id="id1">
<h2><strong>Introduction</strong><a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>Long Short-Term Memory (LSTM) networks are a powerful type of recurrent neural network (RNN) architecture well-suited for time series forecasting tasks. Unlike traditional RNNs, LSTMs can effectively capture long-term dependencies within sequential data, making them a popular choice for predicting future values based on historical information.</p>
</section>
<section id="data-preparation">
<h2><strong>Data Preparation</strong><a class="headerlink" href="#data-preparation" title="Link to this heading"></a></h2>
<p>This section details the steps taken to prepare the football match data for use with the LSTM model.</p>
<ol class="arabic">
<li><dl>
<dt><strong>Data Loading:</strong></dt><dd><ul class="simple">
<li><p>Load the data from a CSV file.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/home/yassine/football_predict/R_csv/teams_final.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Feature Engineering:</strong></dt><dd><ul class="simple">
<li><p>Create new features from the existing data to potentially improve model performance. This includes:</p></li>
<li><p>Extracting temporal features (week, month, day of week) and converting them to cyclical representations using sine and cosine transformations.</p></li>
<li><p>Creating one-hot encoded columns for each team to represent home/away status.</p></li>
<li><p>Creating lagged features for important numerical columns.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>

<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;DayOfWeek&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span>

<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Week_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Week&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">52</span><span class="p">)</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Week_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Week&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">52</span><span class="p">)</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Month_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Month_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;DayOfWeek_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;DayOfWeek&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">matches</span><span class="p">[</span><span class="s1">&#39;DayOfWeek_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;DayOfWeek&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>

<span class="n">team_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arsenal&#39;</span><span class="p">,</span> <span class="s1">&#39;Aston Villa&#39;</span><span class="p">,</span> <span class="s1">&#39;Bournemouth&#39;</span><span class="p">,</span> <span class="s1">&#39;Brentford&#39;</span><span class="p">,</span> <span class="s1">&#39;Brighton&#39;</span><span class="p">,</span> <span class="s1">&#39;Burnley&#39;</span><span class="p">,</span> <span class="s1">&#39;Cardiff City&#39;</span><span class="p">,</span> <span class="s1">&#39;Chelsea&#39;</span><span class="p">,</span> <span class="s1">&#39;Crystal Palace&#39;</span><span class="p">,</span> <span class="s1">&#39;Everton&#39;</span><span class="p">,</span> <span class="s1">&#39;Fulham&#39;</span><span class="p">,</span> <span class="s1">&#39;Huddersfield&#39;</span><span class="p">,</span> <span class="s1">&#39;Leeds United&#39;</span><span class="p">,</span> <span class="s1">&#39;Leicester City&#39;</span><span class="p">,</span> <span class="s1">&#39;Liverpool&#39;</span><span class="p">,</span> <span class="s1">&#39;Luton Town&#39;</span><span class="p">,</span> <span class="s1">&#39;Manchester City&#39;</span><span class="p">,</span> <span class="s1">&#39;Manchester Utd&#39;</span><span class="p">,</span> <span class="s1">&#39;Newcastle Utd&#39;</span><span class="p">,</span> <span class="s1">&#39;Norwich City&#39;</span><span class="p">,</span> <span class="s1">&#39;Nott</span><span class="se">\&#39;</span><span class="s1">ham Forest&#39;</span><span class="p">,</span> <span class="s1">&#39;Sheffield Utd&#39;</span><span class="p">,</span> <span class="s1">&#39;Southampton&#39;</span><span class="p">,</span> <span class="s1">&#39;Stoke City&#39;</span><span class="p">,</span> <span class="s1">&#39;Swansea City&#39;</span><span class="p">,</span> <span class="s1">&#39;Tottenham&#39;</span><span class="p">,</span> <span class="s1">&#39;Watford&#39;</span><span class="p">,</span> <span class="s1">&#39;West Brom&#39;</span><span class="p">,</span> <span class="s1">&#39;West Ham&#39;</span><span class="p">,</span> <span class="s1">&#39;Wolves&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">team_names</span><span class="p">:</span>
    <span class="n">matches</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Home_</span><span class="si">{</span><span class="n">team</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Home_</span><span class="si">{</span><span class="n">team</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="n">matches</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Away_</span><span class="si">{</span><span class="n">team</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Away_</span><span class="si">{</span><span class="n">team</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">create_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">team_names</span><span class="p">):</span>
    <span class="n">lagged_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">team_names</span><span class="p">:</span>
        <span class="n">team_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Home_</span><span class="si">{</span><span class="n">team</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">team_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">team_df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="n">lagged_df</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">team_df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">team_names</span><span class="p">:</span>
        <span class="n">team_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Away_</span><span class="si">{</span><span class="n">team</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">team_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">team_df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="n">lagged_df</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">team_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lagged_df</span>

<span class="n">features_to_lag</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GoalDifference&#39;</span><span class="p">,</span> <span class="s1">&#39;xG_Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;Sh_per_90_Standard&#39;</span><span class="p">,</span><span class="s1">&#39;Sh_per_90_Standard_Away&#39;</span><span class="p">]</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features_to_lag</span><span class="p">:</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">create_lags</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span><span class="n">team_names</span><span class="p">)</span>

<span class="n">matches</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Feature and Target Selection:</strong></dt><dd><ul class="simple">
<li><p>Define the features (X) and target variable (y).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;GoalDifference&#39;</span><span class="p">]]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;GoalDifference&#39;</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Separate Numerical and Categorical Columns:</strong></dt><dd><ul class="simple">
<li><p>Separate numerical and categorical features and convert categorical features to float type.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Scaling Numerical Columns:</strong></dt><dd><ul class="simple">
<li><p>Scale numerical features using StandardScaler.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">])</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Time Series Split and Data Reshaping:</strong></dt><dd><ul class="simple">
<li><p>Split the data into training, validation, and testing sets while preserving temporal order.</p></li>
<li><p>Reshape the data into the 3D format required by LSTMs (samples, timesteps, features).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">train_size</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">train_size</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">train_size</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_size</span><span class="p">:]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">reshape_data</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">):</span>
    <span class="n">X_reshaped</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="n">timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">X_reshaped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">timesteps</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_reshaped</span><span class="p">)</span>

<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">reshape_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="n">X_val</span> <span class="o">=</span> <span class="n">reshape_data</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">reshape_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">timesteps</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">y_val</span><span class="p">[</span><span class="n">timesteps</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">timesteps</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ol>
</section>
<section id="id2">
<h2><strong>Model Building</strong><a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><dl class="simple">
<dt><strong>Reshaping Data for LSTM Input:</strong></dt><dd><ul class="simple">
<li><p>Reshape your features into a format suitable for LSTM input. This typically involves creating sequences of past observations for each time step. The function <cite>reshape_data</cite> demonstrates this process.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Define the LSTM Model:</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Use TensorFlow’s Keras API to define the LSTM architecture. Here’s an example structure:</dt><dd><ul>
<li><p><strong>Input Layer:</strong> Define the shape of the input sequences.</p></li>
<li><p><strong>LSTM Layers:</strong> Utilize LSTM layers with desired units and activation functions to capture temporal dependencies. You can use dropout layers for regularization.</p></li>
<li><p><strong>Dense Layers:</strong> Add dense layers with activation functions to process the extracted features and generate the final prediction.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Compile the Model:</strong></dt><dd><ul class="simple">
<li><p>Specify the optimizer (e.g., Adam), loss function (e.g., mean squared error), and any other necessary compilation options for training.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Train the Model:</strong></dt><dd><ul class="simple">
<li><p>Train the model on the training data, potentially using callbacks like EarlyStopping to prevent overfitting and ModelCheckpoint to save the best performing model based on validation loss.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Evaluate the Model:</strong></dt><dd><ul class="simple">
<li><p>Load the best model and use it to make predictions on the test set.</p></li>
<li><p>Calculate evaluation metrics like Mean Squared Error (MSE) and Root Mean Squared Error (RMSE) to assess the model’s performance on unseen data.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p><strong>Example Code</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># (Data Loading and Feature Engineering omitted for brevity)</span>

<span class="c1"># Feature and Target Selection</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;GoalDifference&#39;</span><span class="p">]]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;GoalDifference&#39;</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="c1"># (Separate Numerical and Categorical Columns, Scaling, Time Series Split omitted for brevity)</span>

<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">reshape_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="n">X_val</span> <span class="o">=</span> <span class="n">reshape_data</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">reshape_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">timesteps</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">y_val</span><span class="p">[</span><span class="n">timesteps</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">timesteps</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="c1">#Convert to numpy</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">X_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="model-visualization">
<h2><strong>Model Visualization</strong><a class="headerlink" href="#model-visualization" title="Link to this heading"></a></h2>
<p><strong>Example code</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time Series Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual Goal Difference&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted Goal Difference&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Match Index (Time Step)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Goal Difference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time Series: Actual vs. Predicted Goal Difference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/lstm.png"><img alt="_images/lstm.png" src="_images/lstm.png" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In our case, the LSTM model yielded the following results:</p>
<ul class="simple">
<li><p>RMSE: 0.856</p></li>
</ul>
<dl class="simple">
<dt><strong>Observation:</strong></dt><dd><p>The RMSE achieved by the LSTM model on the test data is 0.856.
This indicates the average magnitude of the errors in the model’s predictions.
The time series plot visually compares the actual and predicted goal differences over time.
As can be seen in the plot, the model captures some of the general trends in the data,
but it also struggles with predicting more extreme values or sudden changes.
The predictions tend to follow a smoother trajectory compared to the more volatile actual values.
This could be due to the inherent difficulty in predicting such events or limitations in the model’s architecture or features.
Further investigation, such as comparing this RMSE to other models (e.g., SARIMAX) or analyzing the model’s residuals, is recommended.</p>
</dd>
</dl>
</div>
</section>
</section>
<section id="enhanced-transformer-model">
<span id="transformer-modeling"></span><h1>Enhanced Transformer Model<a class="headerlink" href="#enhanced-transformer-model" title="Link to this heading"></a></h1>
<section id="id3">
<h2><strong>Introduction</strong><a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>Transformers are a powerful neural network architecture that has achieved state-of-the-art results in various sequence modeling tasks, including natural language processing and time series forecasting. Unlike recurrent neural networks (RNNs), Transformers rely on attention mechanisms to capture long-range dependencies in data, allowing for parallel processing and improved performance. This section describes an enhanced Transformer model designed for predicting goal differences in football matches.</p>
</section>
<section id="model-architecture">
<h2><strong>Model Architecture</strong><a class="headerlink" href="#model-architecture" title="Link to this heading"></a></h2>
<p>This subsection describes the architecture of the enhanced Transformer model used for time series forecasting.</p>
<ul class="simple">
<li><p><strong>Input Layer:</strong> The model takes input sequences of shape <code class="docutils literal notranslate"><span class="pre">(timesteps,</span> <span class="pre">features)</span></code>, where <code class="docutils literal notranslate"><span class="pre">timesteps</span></code> represents the number of past time steps considered and <code class="docutils literal notranslate"><span class="pre">features</span></code> represents the number of features at each time step.</p></li>
<li><p><strong>Transformer Encoder Block:</strong> The core of the model is the Transformer encoder block, which consists of the following components:</p>
<ul>
<li><p><strong>Multi-Head Attention:</strong> This mechanism allows the model to attend to different parts of the input sequence simultaneously, capturing complex relationships between time steps. The model uses 8 attention heads.</p></li>
<li><p><strong>Layer Normalization:</strong> This technique stabilizes training by normalizing the activations within each layer.</p></li>
<li><p><strong>Residual Connection:</strong> This connection adds the input of a sub-layer to its output, aiding in gradient flow and improving training.</p></li>
</ul>
</li>
<li><p><strong>Feedforward Network:</strong> After the attention mechanism, a feedforward network is applied to each time step independently. This network consists of two dense layers with ReLU activation and L2 regularization. Dropout is applied after the first Dense layer.</p></li>
<li><p><strong>Global Average Pooling:</strong> This layer condenses the sequence representation into a fixed-size vector by averaging the outputs across all time steps.</p></li>
<li><p><strong>Dense Layers:</strong> Finally, two dense layers with ReLU activation, L2 regularization, and dropout are used to perform the regression task, predicting the goal difference.</p></li>
<li><p><strong>Output Layer:</strong> The final dense layer has a single output unit, representing the predicted goal difference.</p></li>
</ul>
</section>
<section id="model-implementation">
<h2><strong>Model Implementation</strong><a class="headerlink" href="#model-implementation" title="Link to this heading"></a></h2>
<p>This subsection provides the Python code implementation of the enhanced Transformer model using TensorFlow/Keras.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">LayerNormalization</span><span class="p">,</span> <span class="n">MultiHeadAttention</span><span class="p">,</span> <span class="n">GlobalAveragePooling1D</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.regularizers</span> <span class="kn">import</span> <span class="n">l2</span>

<span class="k">def</span> <span class="nf">create_enhanced_transformer_model</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">features</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_layer&quot;</span><span class="p">)</span>

    <span class="n">attention_output</span> <span class="o">=</span> <span class="n">MultiHeadAttention</span><span class="p">(</span><span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">key_dim</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">input_layer</span><span class="p">)</span>
    <span class="n">attention_output</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)(</span><span class="n">attention_output</span><span class="p">)</span>
    <span class="n">attention_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">attention_output</span><span class="p">])</span>

    <span class="n">feedforward_output</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))(</span><span class="n">attention_output</span><span class="p">)</span>
    <span class="n">feedforward_output</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))(</span><span class="n">feedforward_output</span><span class="p">)</span>
    <span class="n">feedforward_output</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">feedforward_output</span><span class="p">)</span>
    <span class="n">feedforward_output</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)(</span><span class="n">feedforward_output</span><span class="p">)</span>
    <span class="n">transformer_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">attention_output</span><span class="p">,</span> <span class="n">feedforward_output</span><span class="p">])</span>

    <span class="n">pooled_output</span> <span class="o">=</span> <span class="n">GlobalAveragePooling1D</span><span class="p">()(</span><span class="n">transformer_output</span><span class="p">)</span>

    <span class="n">dense_1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))(</span><span class="n">pooled_output</span><span class="p">)</span>
    <span class="n">dropout_1</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
    <span class="n">dense_2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))(</span><span class="n">dropout_1</span><span class="p">)</span>
    <span class="n">dropout_2</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">dense_2</span><span class="p">)</span>
    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">dropout_2</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</section>
<section id="model-training-and-evaluation">
<h2><strong>Model Training and Evaluation</strong><a class="headerlink" href="#model-training-and-evaluation" title="Link to this heading"></a></h2>
<p>This subsection describes the training process and evaluation metrics used for the Transformer model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... (Data preparation from previous sections)</span>

<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_enhanced_transformer_model</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/transformer.png"><img alt="Time Series Plot of Actual vs. Predicted Goal Difference using Transformer Model" src="_images/transformer.png" style="width: 800px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Transformer model achieved the following results on the test data:</p>
<ul class="simple">
<li><p>RMSE: 1.005</p></li>
<li><p>MAE: 0.780</p></li>
</ul>
<dl class="simple">
<dt><strong>Observation:</strong></dt><dd><p>The RMSE (1.005) is higher than the MAE (0.780),
which suggests the presence of some larger prediction errors, as RMSE is more sensitive to outliers.
The difference between the RMSE and MAE is more pronounced in the Transformer Model than in the LSTM model.
This suggests that the Transformer model struggles more with outliers. The time series plot should provide a visual representation of the model’s performance, showing how well the predicted
values align with the actual goal differences over time. Further analysis, such as comparing these results with the LSTM and SARIMAX models or examining the distribution of prediction errors,
would be valuable for a comprehensive evaluation.</p>
</dd>
</dl>
</div>
</section>
</section>
<section id="general-conclusion">
<h1><strong>General Conclusion</strong><a class="headerlink" href="#general-conclusion" title="Link to this heading"></a></h1>
<p>This project explored the effectiveness of three different time series forecasting models—SARIMAX, LSTM, and a custom-built Transformer model—for predicting goal differences in English Premier League football matches. By leveraging historical match data and relevant features, we aimed to provide insights into potential match outcomes.</p>
<p><strong>Key Findings:</strong></p>
<ul class="simple">
<li><p><strong>SARIMAX:</strong> The SARIMAX model, a traditional statistical method, provided a useful baseline for comparison. It effectively captured some of the underlying patterns in the time series data, particularly when seasonality was a prominent factor. However, its linear nature limited its ability to capture more complex, non-linear relationships present in the data.</p></li>
<li><p><strong>LSTM:</strong> The LSTM network, a type of recurrent neural network, demonstrated an improved ability to learn from sequential data and capture long-term dependencies. It generally outperformed the SARIMAX model, suggesting that the temporal ordering of matches plays a significant role in predicting goal differences. The LSTM’s ability to retain information over longer sequences proved advantageous.</p></li>
<li><p><strong>Transformer:</strong> The Transformer model, a more recent architecture based on attention mechanisms, also showed promising results, demonstrating the capacity to learn complex relationships within the data. However, as evidenced by the higher RMSE compared to MAE, the Transformer model was more susceptible to outlier predictions in this specific application.</p></li>
</ul>
<p><strong>Model Comparison:</strong></p>
<p>Here’s a summary of the models’ performance based on RMSE (lower is better):</p>
<ul class="simple">
<li><p><strong>SARIMAX:</strong> 0.822</p></li>
<li><p><strong>LSTM:</strong> 0.856</p></li>
<li><p><strong>Transformer:</strong> 1.005</p></li>
</ul>
<p>Based on these results, the SARIMAX model achieved the best performance in terms of RMSE, followed by the LSTM model, and then the Transformer model. This result was different than initial expectations, where it was expected that the LSTM model would outperform the SARIMAX model.</p>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Contrary to initial expectations, the SARIMAX model outperformed the LSTM model in terms of RMSE. This suggests that the linear relationships captured by SARIMAX were more dominant in this dataset than initially anticipated, or that the LSTM wasn’t able to fully exploit the sequential information given the current architecture and feature set.</p></li>
<li><p>The Transformer model, while powerful in other domains, did not perform as well as the other two models in this specific task. The higher RMSE compared to MAE suggests it is more sensitive to outliers, which could be due to overfitting on certain data points or an insufficient amount of training data for such a complex model. This also might indicate that the data is not well suited for the Transformer model’s particular strengths.</p></li>
<li><p>Traditional time series models like SARIMAX can still provide a valuable baseline and offer advantages in terms of interpretability and computational efficiency. They can be particularly effective when the underlying time series exhibits strong linear or seasonal patterns.</p></li>
<li><p>The difference between RMSE and MAE was more pronounced in the Transformer model, further reinforcing the observation of its increased sensitivity to outliers compared to the LSTM and SARIMAX models.</p></li>
</ul>
<p><strong>Future Work:</strong></p>
<p>Several avenues for future work could further enhance this project:</p>
<ul class="simple">
<li><p><strong>Feature Engineering:</strong> Exploring additional features, such as player statistics (e.g., goals per game, assists), team form indicators (e.g., win streaks, recent performance against similar opponents), or even external factors like weather conditions, could potentially improve model accuracy.</p></li>
<li><p><strong>Hyperparameter Tuning:</strong> More extensive hyperparameter tuning for all models, especially the LSTM and Transformer models, could lead to better performance. Techniques like Bayesian optimization or more extensive grid searches could be explored. Particularly, the Transformer model might benefit from more extensive tuning and architectural adjustments.</p></li>
<li><p><strong>Model Ensembling:</strong> Combining the predictions of multiple models (e.g., LSTM and Transformer) through ensembling techniques could potentially lead to more robust and accurate forecasts.</p></li>
<li><p><strong>Advanced Transformer Architectures:</strong> Exploring more advanced Transformer variants, such as those incorporating positional encodings or more complex attention mechanisms, might yield further improvements.</p></li>
<li><p><strong>Error Analysis:</strong> A more in-depth analysis of the models’ prediction errors, including investigating the specific matches where the models performed poorly, could provide valuable insights into their strengths and weaknesses and guide future development.</p></li>
<li><p><strong>Data Augmentation:</strong> Given the complexity of the Transformer model, exploring data augmentation techniques could potentially improve its generalization performance.</p></li>
</ul>
<p><strong>Conclusion:</strong></p>
<p>This project demonstrated the application of time series forecasting techniques for predicting goal differences in football matches. While the SARIMAX model achieved the best overall performance in this study, the LSTM and Transformer models offer valuable insights and demonstrate the potential of deep learning for this task. The results highlight the importance of careful model selection and the need to consider the specific characteristics of the data when choosing a forecasting approach. Further research, including feature engineering, hyperparameter tuning, and exploring more advanced model architectures, could lead to even more accurate and insightful tools for football analysis.</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, yassine.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>